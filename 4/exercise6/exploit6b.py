#!/usr/bin/env python
# -*- coding: utf-8 -*-
# This exploit template was generated via:
# $ pwn template
from pwn import *

# Set up pwntools for the correct architecture
context.update(arch='amd64')
exe = 'handout/exercise6/exercise6b'

# Many built-in settings can be controlled on the command-line and show up
# in "args".  For example, to dump all data sent/received, and disable ASLR
# for all created processes...
# ./exploit.py DEBUG NOASLR


def start(argv=[], *a, **kw):
    '''Start the exploit against the target.'''
    if args.GDB:
        return gdb.debug([exe] + argv, gdbscript=gdbscript, *a, **kw)
    else:
        return process([exe] + argv, *a, **kw)

# Specify your GDB script here for debugging
# GDB will be launched if the exploit is run via e.g.
# ./exploit.py GDB
gdbscript = '''
c
'''.format(**locals())

#===========================================================
#                    EXPLOIT GOES HERE
#===========================================================

r = start()

# You can now communicate with the process, e.g.,
# r.sendline("AAAAA")
# r.recvline()

'''
arch     x86
baddr    0x400000
binsz    16626
bintype  elf
bits     64
canary   false
class    ELF64
compiler GCC: (Ubuntu 9.4.0-1ubuntu1~20.04.1) 9.4.0
crypto   false
endian   little
havecode true
intrp    /lib64/ld-linux-x86-64.so.2
laddr    0x0
lang     c
linenum  true
lsyms    true
machine  AMD x86-64 architecture
maxopsz  16
minopsz  1
nx       false
os       linux
pcalign  0
pic      false
relocs   true
relro    partial
rpath    NONE
sanitiz  false
static   false
stripped false
subsys   linux
va       true
'''
'''
0x00402008 47 str.Path_of_current_working_directory_is_too_long.
0x00402038 50 str.Enter_1_to_add_a_new_note_or_2_to_show_all_notes:
0x0040206b 10 str.da
0x00402079 21 str.Could_not_open_file.
0x00402090 23 str.Command_not_supported.
0x004020a7 17 str.Enter_your_note:
0x004020b8 25 str.Could_not_write_to_file.
0x004020d1 25 str.Could_not_read_real_UID.
0x004020f0 35 str.Input_contains_illegal_characters.
0x00402113 9 str.s_c_s_c
0x00402120 34 str.Note_has_been_appended_to__s__s.
0x00402142 21 str.Could_not_read_file.
0x00402158 57 str.Could_not_read_notes_because_the_file_format_is_corrupt.
0x00402198 39 str.Found_the_following_notes_for_UID__s:
0x004021bf 28 str.Timestamp:__s__Content:__s
0x004021db 22 str.d_notes_in_total.
0x004021f4 10 str.token:__s
0x004021fe 30 str.Error:__s_Terminate_program.
0x0040221c 28 str.d__02d__02d__02d:_02d:_02d
'''
'''
0x00401436 79 sym.readLine
0x00401485 356 main
0x00401485 356 sym.main
0x004015e9 37 sym.is_valid_cmd
0x0040160e 10 sym.reverse_buffer
0x0040161b 107 sym.is_illegal
0x00401686 73 sym.check_input
0x004016cf 639 sym.add_note
0x0040194e 320 sym.show_notes
0x00401a8e 459 sym.find_note
0x00401c59 50 sym.error
0x00401c8b 185 sym.get_now
'''

'''
FILE_HEADER:
00000000004041c8         dq         0x00000000004041a0
'''
'''
                            saved_uid:
0000000000404300         db  0x00 ; '.'                                         ; DATA XREF=main+24, add_note+173, show_notes+115
0000000000404301         db  0x00 ; '.'
0000000000404302         db  0x00 ; '.'
0000000000404303         db  0x00 ; '.'
0000000000404304         db  0x00 ; '.'
0000000000404305         db  0x00 ; '.'
0000000000404306         db  0x00 ; '.'
0000000000404307         db  0x00 ; '.'
'''

#0x004020f0 35 str.Input_contains_illegal_characters. used in add_note(arg1)

'''
>>> 0x268
616
>>> 0x260
608
>>> 0x240
576
>>> 0xf6
246
>>> 0xf0
240
>>> 0x18
24
>>> 0x8
8

add_note(fileobj):
    stream = fileobj
    var18h = ftell(stream) #current pos in file
    memset(s, 0, 0xd8) #0xd8 = 216
    puts("Enter your note")
    readLine(s)
    
    if(var18h == -1)
        error("Could not open file")
    
    if(var18h == 0):
        rax = fwrite(fileheader, 1, 32, stream) #write ele in fileheader to stream, number of elements to write
        if (rax != 32)
            error(could not write to file)
    
    rax = snprintf(format, 6, %d, obj.savued_uid)
    if (rax != 0)
        error(could not read real UID)
    
    get_now(var_260h, 20)
    
    memset(*ptr, 0, 0x13c)
    
    rax = check_input(s)
    
    if (rax != 0)
        erro(input contains illegal chaacters.)
    
    snprintf(ptr, 0x13c, %s%c%s%c, format, note_field_sep, var_260h)
    
    rax = strlen(ptr)
    
    rbx = fwrite(ptr, 1, rax, stream)
    
    strlen(ptr)
    if (rbx != rax):
        error(could not write to file)
    
    rax = strlen(s)
    
    fwrite(s, 1, rax, stream)
    
    fwrite(note_field_sep, 1, 1, stream)
    
    fwrite(note_delim, 1, 1, stream)
    
    printf(note has been appended to %s %s, obj.cwd, notex.txt)
    
'''

'''
show_notes(fileobj)
    stream = fileobj
    
    rax = fread(ptr, 1, 0x20, stream) #read stream into ptr
    
    if(rax != 0x20)
        error(could not read file)
    
    
    rax = memcmp(ptr, obj.file_header, 0x20)
    
    if (eax != 0)
        error(could not read notes beacause the file format is corrupt)
    
    snprintf(s2, 6, const char *format, obj.saved_uid)
    
    printf(found the following notes for uid %s, s2)
    goto HERE
    
    rax = strcmp(s1, s2) #exploit no limitation
    if rax != 0 GOTO HERE
    
    printf(timestamp %s\ncontent: %s, s1 + 6, s1 + 0x1a)
    
    
    HERE
    rax = find_note(stream, s1)
    if rax != 0 goto LABEL
    
    printf(%d notes in total, var4h)
'''

'''
find note(stream, s1)
'''

'''
Option 1:
    *var8h = fopen(notes.txt, a)
    if (*var8h == 0)
        error(Could not open file)
    chown(notes.txt, 0, 0) (user, group = root)
    chmod(notes.txt, 384) 0600
    add_note(*var8h)
    return 0
    
Option 2:
    *var8h = fopen(notes.txt, r)
    if (*var8h == 0)
        error(Could not open file)
    chown(notes.txt, 0, 0) (user, group = root)
    chmod(notes.txt, 384) 0600
    show_notes(*var8h)
    return 0

Option x:
    return -1
'''


'''

int main(int arg0, int arg1, int arg2) {
    rdx = arg2;
    rsi = arg1;
    rdi = arg0;
    asm { endbr64 };
    rbp = &stack[-8];
    *(int32_t *)(rbp - 0x14) = rdi;
    *(rbp - 0x20) = rsi;
    *(int32_t *)saved_uid = sub_401220();
    sub_401330();
    if (sub_401260() == 0x0) {
            error("Path of current working directory is too long.", 0x100, rdx);
    }
    sub_4011f0(); #puts(enter 1 to add, 2 to show)
    *(int32_t *)(rbp - 0xc) = 0x0;
    sub_401300(); #scanf(const char *format, var_ch)
    rax = *(int32_t *)(rbp - 0xc);
    if (rax == 0x1) goto loc_40150c; #option 1

loc_401502:
    if (rax == 0x2) goto loc_40156b; #option 2

loc_4015cf:
    sub_4011f0();
    rax = 0xffffffffffffffff;
    return rax;

loc_40156b: #option 2
    *(rbp - 0x8) = sub_4012e0();
    if (*(rbp - 0x8) == 0x0) {
            error("Could not open file.", 0x40208e, rdx);
    }
    sub_4012c0();
    sub_4012d0();
    show_notes(*(rbp - 0x8));
    goto loc_4015e2;

loc_4015e2:
    rax = 0x0;
    return rax;

loc_40150c: #option 1
    *(rbp - 0x8) = sub_4012e0();
    if (*(rbp - 0x8) == 0x0) {
            error("Could not open file.", 0x40206d, rdx);
    }
    sub_4012c0();
    sub_4012d0();
    add_note(*(rbp - 0x8));
    goto loc_4015e2;
}


'''


'''
                            FORBIDDEN_CHARS:
0000000000404100         db  0x05 ; '.'
0000000000404101         db  0x0a ; '.'
0000000000404102         db  0x0d ; '.'
0000000000404103         db  0x0f ; '.'
0000000000404104         db  0x1e ; '.'
0000000000404105         db  0x82 ; '.'
0000000000404106         db  0x8b ; '.'
0000000000404107         db  0x91 ; '.'
0000000000404108         db  0x95 ; '.'
0000000000404109         db  0x99 ; '.'
000000000040410a         db  0x1e ; '.'
000000000040410b         db  0xa4 ; '.'
000000000040410c         db  0xa6 ; '.'
000000000040410d         db  0xa9 ; '.'
000000000040410e         db  0xcd ; '.'
000000000040410f         db  0xd2 ; '.'
0000000000404110         db  0xe6 ; '.'
0000000000404111         db  0xf6 ; '.'
0000000000404112         db  0xbc ; '.'
0000000000404113         db  0xbe ; '.'
0000000000404114         db  0xbf ; '.'
0000000000404115         db  0xc3 ; '.'
0000000000404116         db  0xc4 ; '.'
0000000000404117         db  0xcb ; '.'
0000000000404118         db  0xcf ; '.'
0000000000404119         db  0xd4 ; '.'
000000000040411a         db  0xd6 ; '.'
000000000040411b         db  0xdb ; '.'
000000000040411c         db  0xe0 ; '.'
000000000040411d         db  0xe9 ; '.'
000000000040411e         db  0xf3 ; '.'
000000000040411f         db  0xff ; '.'
0000000000404120         db  0x05 ; '.'
0000000000404121         db  0x0a ; '.'
0000000000404122         db  0x0d ; '.'
0000000000404123         db  0x0f ; '.'
0000000000404124         db  0x1e ; '.'
0000000000404125         db  0x82 ; '.'
0000000000404126         db  0x8b ; '.'
0000000000404127         db  0x91 ; '.'
0000000000404128         db  0x95 ; '.'
0000000000404129         db  0x99 ; '.'
000000000040412a         db  0x1e ; '.'
000000000040412b         db  0xa4 ; '.'
000000000040412c         db  0xa6 ; '.'
000000000040412d         db  0xa9 ; '.'
000000000040412e         db  0xcd ; '.'
000000000040412f         db  0xd2 ; '.'
0000000000404130         db  0xe6 ; '.'
0000000000404131         db  0xf6 ; '.'
0000000000404132         db  0xc8 ; '.'
0000000000404133         db  0xb8 ; '.'
0000000000404134         db  0xda ; '.'
0000000000404135         db  0xbe ; '.'
0000000000404136         db  0xd6 ; '.'
0000000000404137         db  0xc4 ; '.'
0000000000404138         db  0xcf ; '.'
0000000000404139         db  0xc3 ; '.'
000000000040413a         db  0xce ; '.'
000000000040413b         db  0xd9 ; '.'
000000000040413c         db  0xe0 ; '.'
000000000040413d         db  0xe9 ; '.'
000000000040413e         db  0xf3 ; '.'
000000000040413f         db  0xff ; '.'
0000000000404140         db  0x05 ; '.'
0000000000404141         db  0x0a ; '.'
0000000000404142         db  0x0d ; '.'
0000000000404143         db  0x0f ; '.'
0000000000404144         db  0x1e ; '.'
0000000000404145         db  0x82 ; '.'
0000000000404146         db  0x8b ; '.'
0000000000404147         db  0x91 ; '.'
0000000000404148         db  0x95 ; '.'
0000000000404149         db  0x99 ; '.'
000000000040414a         db  0x1e ; '.'
000000000040414b         db  0xa4 ; '.'
000000000040414c         db  0xa6 ; '.'
000000000040414d         db  0xa9 ; '.'
000000000040414e         db  0xcd ; '.'
000000000040414f         db  0xd2 ; '.'
0000000000404150         db  0xe6 ; '.'
0000000000404151         db  0xf6 ; '.'
0000000000404152         db  0xc8 ; '.'
0000000000404153         db  0xb8 ; '.'
0000000000404154         db  0xda ; '.'
0000000000404155         db  0xbc ; '.'
0000000000404156         db  0xc4 ; '.'
0000000000404157         db  0xcf ; '.'
0000000000404158         db  0xc3 ; '.'
0000000000404159         db  0xbf ; '.'
000000000040415a         db  0xdd ; '.'
000000000040415b         db  0xce ; '.'
000000000040415c         db  0xe0 ; '.'
000000000040415d         db  0xe9 ; '.'
000000000040415e         db  0xf3 ; '.'
000000000040415f         db  0xff ; '.'
0000000000404160         db  0x05 ; '.'
0000000000404161         db  0x0a ; '.'
0000000000404162         db  0x0d ; '.'
0000000000404163         db  0x0f ; '.'
0000000000404164         db  0x1e ; '.'
0000000000404165         db  0x82 ; '.'
0000000000404166         db  0x8b ; '.'
0000000000404167         db  0x91 ; '.'
0000000000404168         db  0x95 ; '.'
0000000000404169         db  0x99 ; '.'
000000000040416a         db  0x1e ; '.'
000000000040416b         db  0xa4 ; '.'
000000000040416c         db  0xa6 ; '.'
000000000040416d         db  0xa9 ; '.'
000000000040416e         db  0xcd ; '.'
000000000040416f         db  0xd2 ; '.'
0000000000404170         db  0xe6 ; '.'
0000000000404171         db  0xf6 ; '.'
0000000000404172         db  0xc8 ; '.'
0000000000404173         db  0xb9 ; '.'
0000000000404174         db  0xda ; '.'
0000000000404175         db  0xbb ; '.'
0000000000404176         db  0xcb ; '.'
0000000000404177         db  0xcf ; '.'
0000000000404178         db  0xbf ; '.'
0000000000404179         db  0xc3 ; '.'
000000000040417a         db  0xd7 ; '.'
000000000040417b         db  0xc9 ; '.'
000000000040417c         db  0xe0 ; '.'
000000000040417d         db  0xe9 ; '.'
000000000040417e         db  0xf3 ; '.'
000000000040417f         db  0xff ; '.'
0000000000404180         db  0x05 ; '.'
0000000000404181         db  0x0a ; '.'
0000000000404182         db  0x0d ; '.'
0000000000404183         db  0x0f ; '.'
0000000000404184         db  0x1e ; '.'
0000000000404185         db  0x82 ; '.'
0000000000404186         db  0x8b ; '.'
0000000000404187         db  0x91 ; '.'
0000000000404188         db  0x95 ; '.'
0000000000404189         db  0x99 ; '.'
000000000040418a         db  0x1e ; '.'
000000000040418b         db  0xa4 ; '.'
000000000040418c         db  0xa6 ; '.'
000000000040418d         db  0xa9 ; '.'
000000000040418e         db  0xcd ; '.'
000000000040418f         db  0xd2 ; '.'
0000000000404190         db  0xe6 ; '.'
0000000000404191         db  0xf6 ; '.'
0000000000404192         db  0xda ; '.'
0000000000404193         db  0xbb ; '.'
0000000000404194         db  0xbc ; '.'
0000000000404195         db  0xcb ; '.'
0000000000404196         db  0xc4 ; '.'
0000000000404197         db  0xcf ; '.'
0000000000404198         db  0xbf ; '.'
0000000000404199         db  0xc3 ; '.'
000000000040419a         db  0xd2 ; '.'
000000000040419b         db  0xcd ; '.'
000000000040419c         db  0xe0 ; '.'
000000000040419d         db  0xe9 ; '.'
000000000040419e         db  0xf3 ; '.'
000000000040419f         db  0xff ; '.'
00000000004041a0         db  0x05 ; '.'                                         ; DATA XREF=FILE_HEADER
00000000004041a1         db  0x0a ; '.'
00000000004041a2         db  0x0d ; '.'
00000000004041a3         db  0x0f ; '.'
00000000004041a4         db  0x1e ; '.'
00000000004041a5         db  0x82 ; '.'
00000000004041a6         db  0x8b ; '.'
00000000004041a7         db  0x91 ; '.'
00000000004041a8         db  0x95 ; '.'
00000000004041a9         db  0x99 ; '.'
00000000004041aa         db  0x1e ; '.'
00000000004041ab         db  0xa4 ; '.'
00000000004041ac         db  0xa6 ; '.'
00000000004041ad         db  0xa9 ; '.'
00000000004041ae         db  0xcd ; '.'
00000000004041af         db  0xd2 ; '.'
00000000004041b0         db  0xe6 ; '.'
00000000004041b1         db  0xf6 ; '.'
00000000004041b2         db  0xc8 ; '.'
00000000004041b3         db  0xda ; '.'
00000000004041b4         db  0xba ; '.'
00000000004041b5         db  0xbc ; '.'
00000000004041b6         db  0xcb ; '.'
00000000004041b7         db  0xbe ; '.'
00000000004041b8         db  0xd6 ; '.'
00000000004041b9         db  0xc4 ; '.'
00000000004041ba         db  0xd5 ; '.'
00000000004041bb         db  0xce ; '.'
00000000004041bc         db  0xe0 ; '.'
00000000004041bd         db  0xe9 ; '.'
00000000004041be         db  0xf3 ; '.'
00000000004041bf         db  0xff ; '.'
                            NOTE_DELIM:
00000000004041c0         db         0xe1                                        ; DATA XREF=is_illegal+62, add_note+578, find_note+50, find_note+378
                            NOTE_FIELD_SEP:
00000000004041c1         db         0xff                                        ; DATA XREF=is_illegal+81, add_note+305, add_note+315, add_note+546, find_note+36
00000000004041c2         align      8
                            FILE_HEADER:
00000000004041c8         dq         0x00000000004041a0

'''
